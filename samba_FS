#!/bin/bash

if [ "$EUID" == 0 ]; then

    printf "Choose your configuration\n1 - Configure as a Standalone File Server\n"\
"2 - Configure as Domain Member\n"

    Reset=1
    while [ "${Reset}" == 1 ]; do
	read -p ">" ConfigChoice
	if [ "${ConfigChoice}" == 1 ] || [ "${ConfigChoice}" == 2 ]; then
	    Reset=0
	else
	    printf "Must enter 1 or 2\n"
	fi
    done

    if [ "${ConfigChoice}" == 1 ]; then
	apt install samba

	printf "To share a home folder of a user you must create th user in samba using:"\
"smbpasswd -a username"

#potentially choices for configuration (read only, browsable....)

    elif [ "${ConfigChoice}" == 2 ]; then

    	printf "Enter the kerberos realm:\n"
    	while [ -z "${KerberosRealm}" ]; do
		read -p ">" KerberosRealm
	    	if [ -z "${KerberosRealm}" ]; then
	    		printf "The kerberos realm must not be empty"
		fi
    	done
	
    	printf "Enter the IP of the primary DC:\n"
    	while [ -z "${PDCIP}" ]; do
		read -p ">" PDCIP
	    	if [ -z "${PDCIP}" ]; then
	    		printf "The IP if the primary DC must not be empty"
		fi
    	done
	

	DEBIAN_FRONTEND=noninteractive apt -yq install acl attr samba samba-dsdb-modules samba-vfs-modules winbind libpam-winbind libnss-winbind libpam-krb5 krb5-config krb5-user dnsutils resolvconf

	nameservers="nameserver ${PDCIP}\nsearch ${KerberosRealm^^}\n"
	sed -i "s/nameserver ${PDCIP}//g" /etc/resolvconf/resolv.conf.d/head
	sed -i "s/search ${KerberosRealm^^}//g" /etc/resolvconf/resolv.conf.d/head
	nameservers="${nameservers}$(cat /etc/resolvconf/resolv.conf.d/head | grep -w nameserver)\n"
	printf "${nameservers}" > /etc/resolvconf/resolv.conf.d/head

	systemctl restart resolvconf

	printf "[libdefaults]\n default_realm = ${KerberosRealm^^}\ndns_lookup_realm = false\ndns_lookup_kdc = true" > /etc/krb5.conf

	cp /etc/samba/smb.conf /etc/samba/smb.conf.bckp
	cp ./.smb.conf /etc/samba/smb.conf
	smbcontrol all reload-config

	net ads join -U administrator

	passwdline=$(cat /etc/nsswitch.conf | grep -w passwd)
	groupline=$(cat /etc/nsswitch.conf | grep -w group)
	passwdlinenew="${passwdline} winbind"
	grouplinenew="${groupline} winbind"

	sed -i "s/${passwdline}/${passwdlinenew}/" /etc/nsswitch.conf
	sed -i "s/${groupline}/${grouplinenew}/" /etc/nsswitch.conf

	systemctl restart smbd nmbd winbind

    fi

else

    printf "This script must be run as root"

fi

exit 0
